<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠ ğŸ›°ï¸</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 60vh; width: 100%; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 2px solid #fff; }
        
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            color: white; /* Ø§Ù„Ù†Øµ Ø£Ø¨ÙŠØ¶ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© */
        }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª */
        .status-gps { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); } /* Ø£Ø®Ø¶Ø± Ù…ØªØ¯Ø±Ø¬ */
        .status-wifi { background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%); } /* Ø£Ø²Ø±Ù‚ Ù…ØªØ¯Ø±Ø¬ */
        .status-tower { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); color: #333 !important; } /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
        .status-unknown { background-color: #6c757d; }

        .icon-large { font-size: 2.5rem; margin-bottom: 10px; }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø®ØµØµØ© */
        .map-icon {
            text-align: center;
            line-height: 40px;
            border-radius: 50%;
            color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            font-size: 20px;
        }
        .marker-gps { background-color: #28a745; border: 2px solid white; }
        .marker-wifi { background-color: #17a2b8; border: 2px solid white; }
        .marker-tower { background-color: #ffc107; color: black; border: 2px solid white; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark"><i class="fas fa-map-location-dot text-primary"></i> ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
        <span class="badge bg-secondary p-2" id="connectionStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div id="mainCard" class="card card-custom p-4 status-unknown">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <i id="mainIcon" class="fas fa-satellite-dish icon-large"></i>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-uppercase opacity-75">Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</h6>
                        <h2 id="sourceType" class="fw-bold mb-0">--</h2>
                        <small id="lastUpdate" class="d-block mt-2">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</small>
                    </div>
                    <div class="col-md-4 text-center border-start border-light">
                        <h6 class="text-uppercase opacity-75">Ø¯Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯</h6>
                        <h1 id="accuracy" class="fw-bold display-5">--</h1>
                        <span>Ù…ØªØ±</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div id="map"></div>
        </div>
    </div>
    
    <div class="d-grid gap-2 mt-3">
        <a id="googleLink" href="#" target="_blank" class="btn btn-dark btn-lg">
            <i class="fas fa-external-link-alt"></i> ÙØªØ­ ÙÙŠ Google Maps
        </a>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // ğŸ›‘ğŸ›‘ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ ğŸ›‘ğŸ›‘
    const firebaseURL = "https://gps-tracker-534ae-default-rtdb.firebaseio.com/gps.json";

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    var map = L.map('map').setView([33.3152, 44.3661], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
    var currentMarker = null;
    var currentCircle = L.circle([0,0], {radius: 1}).addTo(map);

    function updateDashboard(data) {
        if (!data || !data.lat) return;

        var lat = parseFloat(data.lat);
        var lng = parseFloat(data.lng);
        var acc = data.accuracy || 0;
        var rawType = data.type || "";
        
        // 1. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ¯Ø± (Logic)
        var mode = "unknown";
        if (rawType.includes("GPS")) mode = "gps";
        else if (rawType.includes("WiFi")) mode = "wifi";
        else if (rawType.includes("Tower") || rawType.includes("Cell")) mode = "tower";

        // 2. ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        var card = document.getElementById('mainCard');
        var icon = document.getElementById('mainIcon');
        
        // Ø­Ø°Ù Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        card.className = "card card-custom p-4"; 
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (mode === "gps") {
            card.classList.add("status-gps");
            icon.className = "fas fa-satellite icon-large";
            document.getElementById('sourceType').innerText = "GPS (Ø£Ù‚Ù…Ø§Ø± ØµÙ†Ø§Ø¹ÙŠØ©)";
        } else if (mode === "wifi") {
            card.classList.add("status-wifi");
            icon.className = "fas fa-wifi icon-large";
            document.getElementById('sourceType').innerText = "WiFi (Ø±Ø§ÙˆØªØ± Ù…Ù†Ø²Ù„ÙŠ)";
        } else if (mode === "tower") {
            card.classList.add("status-tower");
            icon.className = "fas fa-broadcast-tower icon-large";
            document.getElementById('sourceType').innerText = "Cell Tower (Ø¨Ø±Ø¬ Ø®Ù„ÙˆÙŠ)";
        } else {
            card.classList.add("status-unknown");
            document.getElementById('sourceType').innerText = rawType;
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
        document.getElementById('accuracy').innerText = acc;
        var now = new Date();
        document.getElementById('lastUpdate').innerText = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + now.toLocaleTimeString();
        document.getElementById('connectionStatus').innerText = "âœ… Ù…ØªØµÙ„";
        document.getElementById('connectionStatus').className = "badge bg-success p-2";

        // 4. ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ)
        var iconHtml = "";
        var markerClass = "";
        
        if(mode === "gps") { iconHtml = '<i class="fas fa-satellite"></i>'; markerClass = "marker-gps"; }
        else if(mode === "wifi") { iconHtml = '<i class="fas fa-wifi"></i>'; markerClass = "marker-wifi"; }
        else { iconHtml = '<i class="fas fa-broadcast-tower"></i>'; markerClass = "marker-tower"; }

        var customIcon = L.divIcon({
            html: `<div class="map-icon ${markerClass}" style="width: 40px; height: 40px;">${iconHtml}</div>`,
            className: 'custom-div-icon',
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -40]
        });

        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        var newLatLng = new L.LatLng(lat, lng);
        
        if (currentMarker) {
            currentMarker.setLatLng(newLatLng);
            currentMarker.setIcon(customIcon);
        } else {
            currentMarker = L.marker(newLatLng, {icon: customIcon}).addTo(map);
        }

        currentCircle.setLatLng(newLatLng);
        currentCircle.setRadius(acc);
        
        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯Ù‚Ø©
        if(mode === "gps") currentCircle.setStyle({color: 'green', fillColor: '#28a745'});
        else if(mode === "wifi") currentCircle.setStyle({color: 'blue', fillColor: '#17a2b8'});
        else currentCircle.setStyle({color: 'orange', fillColor: '#ffc107'});

        map.setView(newLatLng);
        currentMarker.bindPopup(`<b>${document.getElementById('sourceType').innerText}</b><br>Ø§Ù„Ø¯Ù‚Ø©: ${acc} Ù…ØªØ±`).openPopup();
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø¬ÙˆØ¬Ù„
        document.getElementById('googleLink').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
    }

    function fetchData() {
        fetch(firebaseURL)
            .then(response => response.json())
            .then(data => {
                updateDashboard(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('connectionStatus').innerText = "âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„";
                document.getElementById('connectionStatus').className = "badge bg-danger p-2";
            });
    }

    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
    setInterval(fetchData, 3000);
    fetchData();
</script>

</body>
</html>
